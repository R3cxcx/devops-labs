pipeline {
    agent any

    stages {
        stage('Build') {
            steps {
                sh '''
                    echo "Building Docker image..."
                    docker build -t my-flask-app:latest ./03-docker
                '''
            }
        }

        stage('Test') {
            steps {
                sh '''
                    echo "Running container for testing..."
                    docker rm -f test-app || true
                    docker run -d --name test-app --network jenkins-net my-flask-app:latest
                    sleep 5
                    docker logs test-app
                    curl http://test-app:5000
                '''
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                sh '''
                    echo "Deploying to Kubernetes..."
                    kubectl set image deployment/flask-app flask-app=my-flask-app:latest --record
                '''
            }
        }
    }
}
